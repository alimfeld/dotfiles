#!/bin/sh

eclipse_home="$HOME/.local/lib/eclipse"
jdtls_dir="jdt-language-server"
jdtls_home="$eclipse_home/$jdtls_dir"

while getopts li: opt
do
    case $opt in 
        i) version="$OPTARG";;
        l) list=true;;
        ?) printf "Usage: %s [-l] [-i version]\n" $0
            exit 2;;
    esac
done

if [ $list ]; then
    curl -s "https://download.eclipse.org/jdtls/milestones/" | \
        grep -Po "href='/jdtls/milestones/\K\d+\.\d+\.\d+" | sort -V
    exit 0
fi

if [ ! -z "$version" ]; then
    [ "$version" = "latest" ] && path="snapshots" || path="milestones/$version"
    base_url="https://download.eclipse.org/jdtls/$path"
    archive_file=$(curl -s "$base_url/latest.txt")
    archive_url="$base_url/$archive_file"
    install_dir="${archive_file%.tar.gz}"
    install_path="$eclipse_home/${install_dir}"
    if [ ! -d "$install_path" ]; then
        echo "Downloading $archive_url"
        mkdir -p "$install_path"
        curl "$archive_url" | tar zx -C "$install_path"
    fi
    echo "Symlinking $install_path"
    cd "$eclipse_home" && ln -sfn "$install_dir" "$jdtls_dir"
    exit 0
fi


case "$(uname -s)" in
	Linux*)  config="$jdtls_home/config_linux";;
	Darwin*) config="$jdtls_home/config_mac";;
	*)
esac

java \
	-Declipse.application=org.eclipse.jdt.ls.core.id1 \
	-Dosgi.bundles.defaultStartLevel=4 \
	-Declipse.product=org.eclipse.jdt.ls.core.product \
	-Dlog.protocol=true \
	-Dlog.level=ALL \
	-noverify \
	-Xms1G \
	-Xmx2G \
	-jar $(echo "$jdtls_home/plugins/org.eclipse.equinox.launcher_*.jar") \
	-configuration "$config" \
	-data "${1:-$HOME/workspace}" \
	--add-modules=ALL-SYSTEM \
	--add-opens java.base/java.util=ALL-UNNAMED \
	--add-opens java.base/java.lang=ALL-UNNAMED
